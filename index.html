<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>Europe &amp; Human Trafficking</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bree+Serif">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
  <link href="https://fonts.googleapis.com/css?family=Berkshire+Swash" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="slick/slick.css" /> // Add the new slick-theme.css if you want the default styling
  <link rel="stylesheet" type="text/css" href="slick/slick-theme.css" />

  <link rel="stylesheet" href="simplegallery.css" />

  <style>
    /* custom styles here */

    body {
      font-family: "Raleway", serif;
      color: #008080;
      font-size: 1.3em;
    }

    h1 {
      font-size: 1.6em;
      font-family: 'Berkshire Swash', cursive;
      text-align: center;
    }

    h2 {
      font-size: 1.3em;
      text-align: center;
    }
    h7 {
      font-size: 1.4em;
      font-family: 'Berkshire Swash', cursive;
    }

    #side-col {
      position: absolute;
      width: 25%;
      left: 18px;
      top: 75px;
      bottom: 20px;
      background: #333;
      z-index: 999;
      overflow-y: scroll;
      padding: 18px 12px;
    }

    #map {
      position: absolute;
      width: 100%;
      top: 0;
      bottom: 0;
    }

    #ui {
      position: absolute;
      top: 8px;
      right: 18px;
      z-index: 999;
      background: white;
      width: 120px;
      height: 130px;
    }

    .legend-large,
    .legend-small {
      border-radius: 50%;
    }

    .legend circle {
      fill: none;
      stroke: #ccc;
    }

    .legend text {
      fill: #777;
      font: 10px sans-serif;
      text-anchor: middle;
    }
  </style>
</head>

<body>
  <div id="side-col">
    <!---<h1>Europe &amp; Human Trafficking</h1>--->
    <h1>More than 45.8 million people are in some form of modern slavery in 167 countries throughout the world.</h1>
    <div>
      <img src="images/Stop.jpg" width=370px, height=200px>
    </div>
    <h2>Each line represents the flow of trafficking, from the origin country to the destination country.</h2>
    <div class="your-class">
      <div><img src="images/Branded.jpg" width=180px, height=110px>
           <img src="images/30Seconds.jpg" width=180px, height=110px>
           <br>
           <img src="images/Tied.jpg" width=180px, height=110px>
          <img src="images/NotForSale.jpg" width=180px, height=110px>
      </div>
    </div>
    <p>
      Within Europe, there are currently 2,075,500 victims living in modern slavery due to trafficking. <br> Countries like Luxembourg, Norway, Finland, Sweden, and
      Denmark have higher GDP's than most countries in Europe, and also exhibit very low numbers for trafficking victims. The opposite is true of countries with lower GDP's; they are prone to many more trafficking victims due to poverty levels.
      This can primarily be seen throughout Eastern Europe, where trafficking has increased tremendously over the past couple of decades, following the collapse of the Soviet Union.
    </p>
  </div>

  <div id="map"></div>

  <div id='legend' class='bg-gray-dark round px12 py12 relative'>
    <h3 class='txt-bold mb12 w180'>Number of trafficking victims &amp; GDP PPP</h3>
    <div class='legend-circles relative w180'>
      <div class="legend-large border border--gray-light absolute"></div>
      <div class="legend-small border border--gray-light absolute"></div>
      <h3><div class="legend-large-label txt-m absolute"></div></h3>
      <h3><div class="legend-small-label txt-m absolute"></div></h3>
    </div>
  </div>

  <!-- <div id="ui">
    <form>
        <div>
          <input type="radio" id=""
            name="contact" value="gdp">
          <label for="gdp">GDP Layer</label>
          <input type="radio" id=""
            name="contact" value="flow">
          <label for="flowmap">FLowmap</label>
        </div>
      </form>
  </div> -->


  <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
  <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.js"></script>
  <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
  <script type="text/javascript" src="slick/slick.min.js"></script>

  <!-- load animation tweening lib requirement for CanvasFlowMapLayer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/17.2.0/Tween.min.js"></script>
  <script src="js/CanvasFlowmapLayer.js"></script>
  <!-- <script src="js/jquery.touchSwipe.min.js"></script>
  <script src="js/simplegallery.js"></script> -->



  <script>
    var options = {
      center: [52.805, 1],
      zoom: 4,
      minZoom: 3,
      maxZoom: 6,
    }
    var map = L.map('map', options)
    var OpenStreetMap_Mapnik = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
      // attribute here
    }).addTo(map)
    var flowLayer,
      gdpLayer
    var layerMap = {
      gdp: gdpLayer,
      flow: flowLayer
    };
    // load CSV data
    var trafficData = d3.csv('data/Trafficking_Europe.csv')
    var gdpData = d3.csv('data/PopGDP.csv')
    Promise.all([trafficData, gdpData]).then(dataReady)

    function dataReady(data) {
      var trafficData = data[0],
        gdpData = data[1]
      drawGDPMap(gdpData)
      drawFlowMap(trafficData)
      // makeUI()
    }

    function drawFlowMap(data) {
      // create a new GeoJSON feature collection
      var geojson = {
        "type": "FeatureCollection",
        "features": []
      }
      // loop through the CSV data to build GeoJSON
      data.forEach(function(datum) {
        // create a new Point feature
        var feature = {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [+datum.source_lon, +datum.source_lat]
          },
          "properties": {
            "origin_id": datum.source_ISO,
            "origin_country": datum.source_name,
            "origin_lon": +datum.source_lon,
            "origin_lat": +datum.source_lat,
            "destination_id": datum.dest_ISO,
            "destination_lon": +datum.dest_lon,
            "destination_lat": +datum.dest_lat,
            "weight": +datum.weight
          }
        }
        // push new feature to GeoJSON collection
        geojson.features.push(feature)
      })

      // L.geoJson(geojson).addTo(map)
      flowLayer = L.canvasFlowmapLayer(geojson, {
        style: function(feature) {
          return {
            weight: feature.properties.weight * .2,
            fillOpacity: 0
          }
        },
        originAndDestinationFieldIds: {
          originUniqueIdField: 'origin_id',
          originGeometry: {
            x: 'origin_lon',
            y: 'origin_lat'
          },
          destinationUniqueIdField: 'destination_id',
          destinationGeometry: {
            x: 'destination_lon',
            y: 'destination_lat'
          }
        },
        // some custom options
        pathDisplayMode: 'selection',
        animationStarted: true,
        animationEasingFamily: 'Cubic',
        animationEasingType: 'In',
        animationDuration: 2000
      }).addTo(map)
      flowLayer.on('click', function(e) {
        if (e.sharedOriginFeatures.length) {
          flowLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
        }
        if (e.sharedDestinationFeatures.length) {
          flowLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
        }
      });
      // select RU first and show path
      flowLayer.selectFeaturesForPathDisplayById('origin_id', "RU", true, 'SELECTION_NEW');
    }
    drawLegend(feature, ll)

    function drawGDPMap(data) {
      // create a new GeoJSON feature collection
      var geojson = {
        "type": "FeatureCollection",
        "features": []
      }
      data.forEach(function(datum) {
        // create a new Point feature
        var feature = {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [+datum.long, +datum.lat]
          },
          "properties": datum
        }
        geojson.features.push(feature);
      }) // end forEach loop
      gdpLayer = L.geoJson(geojson, {
        pointToLayer: function(feature, ll) {
          return L.circleMarker(ll, {
            color: "cyan",
            weight: 1,
            fillOpacity: 0,
            radius: calcRadius(feature.properties.GDP)
          })
        },
        onEachFeature: function(feature, layer) {
                layer.bindTooltip("<h7>" + feature.properties.Country_Name + "</h7>" + "<br>" + "Number of Victims: " + "<b>" + feature.properties.Number_Slavery + "</b><br>" + "GPD PPP: " + "<b>" + feature.properties.GDP);
                // when mousing over a layer
                layer.on('mouseover', function() {
                  // change the stroke color and bring that element to the front
                });
                // on mousing off layer
                layer.on('mouseout', function() {
                  // reset the layer style to its original stroke color
                });
              }
      }).addTo(map)
      L.geoJson(geojson, {
        pointToLayer: function(feature, ll) {
          return L.circleMarker(ll, {
            color: "red",
            weight: 1,
            fillOpacity: 0,
            radius: calcRadius(feature.properties.Number_Slavery)
          })
        },
        onEachFeature: function(feature, layer) {
                layer.bindTooltip("<h7>" + feature.properties.Country_Name + "</h7>" + "<br>" +  "Number of Victims: " + "<b>" + feature.properties.Number_Slavery + "</b><br>" + "GPD PPP: " + "<b>" + feature.properties.GDP);
                // when mousing over a layer
                layer.on('mouseover', function() {
                  // change the stroke color and bring that element to the front
                });
                // on mousing off layer
                layer.on('mouseout', function() {
                  // reset the layer style to its original stroke color
                });
              }
      }).addTo(map)
    }

    function calcRadius(val) {
      var radius = Math.sqrt(val / Math.PI);
      return radius * .15;
    }

    function makeUI() {
      var layerControl = {
        "gdp": gdpLayer,
        "flow": flowLayer
      }
      L.control.layers(layerControl, {
        // collapsed: true
      }).addTo(map);


      function drawLegend(feature, ll) {

        // append a new g element
        var legend = feature.properties.Number_Slavery
          .attr("dy", "1.3em") // adjust the vertical displacement
          .attr("class", "legend") // add a class (for CSS)
          .attr("transform", "translate(" + (width - 50) + "," + (height - 20) + ")")
          .selectAll("g") // select all new g elements
          .data([5e6, 2e7]) // apply two numbers (approx median/max)
          .enter().append("g"); // enter and append the two new g elements

        // place the circles vertically and apply radius
        legend.append("circle")
          .attr("cy", function(d) {
            return -radius(d);
          })
          .attr("r", radius);

        // append text to each
        legend.append("text")
          .attr("y", function(d) {
            return -2 * radius(d);
          })
          .attr("dy", "1.3em")
          .text(d3.format(".1s"));

        // append a legend label at bottom
        legend.append("text")
          .attr("y", 16)
          .text("metric tons")

      } // end drawLegend()


      /*  $(document).ready(function() {
          $('.responsive').slick({
            dots: true,
            infinite: false,
            speed: 300,
            slidesToShow: 4,
            slidesToScroll: 4,
            responsive: [{
                breakpoint: 1024,
                settings: {
                  slidesToShow: 3,
                  slidesToScroll: 3,
                  infinite: true,
                  dots: true
                }
              },
              {
                breakpoint: 600,
                settings: {
                  slidesToShow: 2,
                  slidesToScroll: 2
                }
              },
              {
                breakpoint: 480,
                settings: {
                  slidesToShow: 1,
                  slidesToScroll: 1
                }
              }
              // You can unslick at a given breakpoint now by adding:
              // settings: "unslick"
              // instead of a settings object
            ]
          });
        });;
        // $("#ui input").change(function() {
        //   var selection = this.value
        //   if(selection === 'gdp') {
        //     map.removeLayer(flowLayer)
        //     map.addLayer(gdpLayer)
        //   } else {
        //     map.removeLayer(gdpLayer)
        //     map.addLayer(flowLayer)
        //   }
        // })*/
    }
  </script>
</body>

</html>
